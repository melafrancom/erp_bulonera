{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard de Ventas - ERP Bulonera Alvear{% endblock %}

{% block breadcrumb_items %}
  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
  <span class="text-gray-900 font-medium">Ventas</span>
{% endblock %}

{% block mobile_title %}Dashboard de Ventas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
      Dashboard de Ventas
    </h1>
    <p class="text-gray-600">
      Gestión de presupuestos y ventas
    </p>
  </div>

  <!-- Stats Cards Grid - Presupuestos -->
  <div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
      <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
      Presupuestos
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
      
      <!-- Total Presupuestos -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-blue-100 rounded-lg">
            <i data-lucide="file-text" class="w-6 h-6 text-blue-600"></i>
          </div>
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ total_quotes }}</h3>
        <p class="text-sm text-gray-500 mt-1">Total Presupuestos</p>
        <a href="{% url 'sales_web:quote_list' %}" class="text-xs text-blue-600 hover:text-blue-700 mt-2 inline-flex items-center">
          Ver todos
          <i data-lucide="arrow-right" class="w-3 h-3 ml-1"></i>
        </a>
      </div>

      <!-- Presupuestos Enviados -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-orange-100 rounded-lg">
            <i data-lucide="send" class="w-6 h-6 text-orange-600"></i>
          </div>
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ quotes_sent }}</h3>
        <p class="text-sm text-gray-500 mt-1">Presupuestos Enviados</p>
        <div class="text-xs text-gray-400 mt-2">
          Pendientes de respuesta
        </div>
      </div>

      <!-- Presupuestos Aceptados -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-green-100 rounded-lg">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ quotes_accepted }}</h3>
        <p class="text-sm text-gray-500 mt-1">Presupuestos Aceptados</p>
        <div class="text-xs text-gray-400 mt-2">
          Listos para convertir
        </div>
      </div>

      <!-- Presupuestos Pendientes -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-yellow-100 rounded-lg">
            <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
          </div>
          {% if quotes_pending > 0 %}
          <span class="px-2 py-1 bg-yellow-500 text-white text-xs font-bold rounded-full">
            {{ quotes_pending }}
          </span>
          {% endif %}
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ quotes_pending }}</h3>
        <p class="text-sm text-gray-500 mt-1">En Borrador</p>
        <div class="text-xs text-gray-400 mt-2">
          Necesitan ser enviados
        </div>
      </div>

    </div>
  </div>

  <!-- Stats Cards Grid - Ventas -->
  <div class="mb-6 md:mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
      <i data-lucide="shopping-cart" class="w-5 h-5 text-green-600"></i>
      Ventas
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
      
      <!-- Total Ventas -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-purple-100 rounded-lg">
            <i data-lucide="shopping-cart" class="w-6 h-6 text-purple-600"></i>
          </div>
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ total_sales }}</h3>
        <p class="text-sm text-gray-500 mt-1">Total Ventas</p>
        <a href="{% url 'sales_web:sale_list' %}" class="text-xs text-purple-600 hover:text-purple-700 mt-2 inline-flex items-center">
          Ver todas
          <i data-lucide="arrow-right" class="w-3 h-3 ml-1"></i>
        </a>
      </div>

      <!-- Ventas Confirmadas -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-green-100 rounded-lg">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ sales_confirmed }}</h3>
        <p class="text-sm text-gray-500 mt-1">Ventas Confirmadas</p>
        <div class="text-xs text-gray-400 mt-2">
          En proceso
        </div>
      </div>

      <!-- Ventas Entregadas -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-blue-100 rounded-lg">
            <i data-lucide="package" class="w-6 h-6 text-blue-600"></i>
          </div>
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ sales_delivered }}</h3>
        <p class="text-sm text-gray-500 mt-1">Ventas Entregadas</p>
        <div class="text-xs text-gray-400 mt-2">
          Este mes
        </div>
      </div>

      <!-- Ventas con Pago Pendiente -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-red-100 rounded-lg">
            <i data-lucide="dollar-sign" class="w-6 h-6 text-red-600"></i>
          </div>
          {% if sales_pending_payment > 0 %}
          <span class="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
            {{ sales_pending_payment }}
          </span>
          {% endif %}
        </div>
        <h3 class="text-3xl font-bold text-gray-900">{{ sales_pending_payment }}</h3>
        <p class="text-sm text-gray-500 mt-1">Pago Pendiente</p>
        <div class="text-xs text-gray-400 mt-2">
          Requieren seguimiento
        </div>
      </div>

    </div>
  </div>

  <!-- Contenedor Principal de Tablas y Acciones -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 md:mb-8">
    
    <!-- Presupuestos Recientes (2/3) -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Presupuestos Recientes</h2>
          <p class="text-sm text-gray-500 mt-1">Últimos presupuestos creados</p>
        </div>
        <a href="{% url 'sales_web:quote_list' %}" 
           class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
          Ver todos
          <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </a>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Presupuesto
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                Cliente
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Estado
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                Total
              </th>
              <th scope="col" class="relative px-6 py-3">
                <span class="sr-only">Acciones</span>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for quote in recent_quotes %}
            <tr class="hover:bg-gray-50 transition">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ quote.number }}</div>
                <div class="text-sm text-gray-500">{{ quote.date|date:"d/m/Y" }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap hidden md:table-cell">
                <div class="text-sm text-gray-900">{{ quote.customer.business_name|truncatewords:3 }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if quote.status == 'draft' %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    <i data-lucide="edit" class="w-3 h-3 mr-1"></i>
                    Borrador
                  </span>
                {% elif quote.status == 'sent' %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                    <i data-lucide="send" class="w-3 h-3 mr-1"></i>
                    Enviado
                  </span>
                {% elif quote.status == 'accepted' %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
                    Aceptado
                  </span>
                {% elif quote.status == 'rejected' %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>
                    Rechazado
                  </span>
                {% elif quote.status == 'converted' %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <i data-lucide="check-square" class="w-3 h-3 mr-1"></i>
                    Convertido
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    {{ quote.get_status_display }}
                  </span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium hidden sm:table-cell">
                ${{ quote.total|floatformat:2 }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="#" class="text-blue-600 hover:text-blue-900 p-2 hover:bg-blue-50 rounded-lg transition" title="Ver">
                  <i data-lucide="eye" class="w-4 h-4"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="px-6 py-12 text-center">
                <div class="flex flex-col items-center justify-center">
                  <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="file-text" class="w-8 h-8 text-gray-400"></i>
                  </div>
                  <p class="text-gray-500 font-medium">No hay presupuestos recientes</p>
                  <p class="text-sm text-gray-400 mt-1">Crea tu primer presupuesto</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Acciones Rápidas (1/3) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-6">Acciones Rápidas</h2>
      
      <div class="space-y-3">
        <a href="#" 
           class="flex items-center gap-3 p-4 rounded-lg bg-blue-50 hover:bg-blue-100 transition group border border-blue-200">
          <div class="p-3 bg-blue-600 rounded-lg group-hover:bg-blue-700 transition">
            <i data-lucide="file-plus" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-semibold text-blue-900">Crear Presupuesto</p>
            <p class="text-xs text-blue-700 mt-0.5">Nuevo presupuesto</p>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-blue-600"></i>
        </a>

        <a href="#" 
           class="flex items-center gap-3 p-4 rounded-lg bg-green-50 hover:bg-green-100 transition group border border-green-200">
          <div class="p-3 bg-green-600 rounded-lg group-hover:bg-green-700 transition">
            <i data-lucide="shopping-cart" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-semibold text-green-900">Crear Venta</p>
            <p class="text-xs text-green-700 mt-0.5">Nueva venta directa</p>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-green-600"></i>
        </a>

        <a href="{% url 'sales_web:quote_list' %}" 
           class="flex items-center gap-3 p-4 rounded-lg hover:bg-gray-50 transition group border border-gray-200">
          <div class="p-3 bg-gray-100 rounded-lg group-hover:bg-gray-200 transition">
            <i data-lucide="file-text" class="w-6 h-6 text-gray-600"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-semibold text-gray-900">Ver Presupuestos</p>
            <p class="text-xs text-gray-600 mt-0.5">Todos los presupuestos</p>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
        </a>

        <a href="{% url 'sales_web:sale_list' %}" 
           class="flex items-center gap-3 p-4 rounded-lg hover:bg-gray-50 transition group border border-gray-200">
          <div class="p-3 bg-gray-100 rounded-lg group-hover:bg-gray-200 transition">
            <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-semibold text-gray-900">Ver Ventas</p>
            <p class="text-xs text-gray-600 mt-0.5">Todas las ventas</p>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
        </a>
      </div>
    </div>

  </div>

  <!-- Ventas Recientes -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Ventas Recientes</h2>
        <p class="text-sm text-gray-500 mt-1">Últimas ventas realizadas</p>
      </div>
      <a href="{% url 'sales_web:sale_list' %}" 
         class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
        Ver todas
        <i data-lucide="arrow-right" class="w-4 h-4"></i>
      </a>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Venta
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
              Cliente
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Estado
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">
              Pago
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
              Total
            </th>
            <th scope="col" class="relative px-6 py-3">
              <span class="sr-only">Acciones</span>
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for sale in recent_sales %}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ sale.number }}</div>
              <div class="text-sm text-gray-500">{{ sale.date|date:"d/m/Y" }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap hidden md:table-cell">
              <div class="text-sm text-gray-900">{{ sale.customer.business_name|truncatewords:3 }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if sale.status == 'draft' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  Borrador
                </span>
              {% elif sale.status == 'confirmed' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Confirmado
                </span>
              {% elif sale.status == 'in_preparation' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  En Preparación
                </span>
              {% elif sale.status == 'ready' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-200 text-green-900">
                  Listo
                </span>
              {% elif sale.status == 'delivered' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-600 text-white">
                  Entregado
                </span>
              {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  {{ sale.get_status_display }}
                </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap hidden lg:table-cell">
              {% if sale.payment_status == 'unpaid' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  Sin Pagar
                </span>
              {% elif sale.payment_status == 'partially_paid' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                  Pago Parcial
                </span>
              {% elif sale.payment_status == 'paid' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Pagado
                </span>
              {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  {{ sale.get_payment_status_display }}
                </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium hidden sm:table-cell">
              ${{ sale.total|floatformat:2 }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <a href="#" class="text-blue-600 hover:text-blue-900 p-2 hover:bg-blue-50 rounded-lg transition" title="Ver">
                <i data-lucide="eye" class="w-4 h-4"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                  <i data-lucide="shopping-cart" class="w-8 h-8 text-gray-400"></i>
                </div>
                <p class="text-gray-500 font-medium">No hay ventas recientes</p>
                <p class="text-sm text-gray-400 mt-1">Las ventas aparecerán aquí</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
