{% extends 'base/base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - ERP Bulonera Alvear{% endblock %}

{% block breadcrumb_items %}
  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
  <a href="{% url 'core_web:profile' %}" class="hover:text-blue-600 transition">Mi Perfil</a>
  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
  <span class="text-gray-900 font-medium">Cambiar Contraseña</span>
{% endblock %}

{% block mobile_title %}Cambiar Contraseña{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  
  <!-- Info Alert -->
  <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-600 rounded-r-lg">
    <div class="flex items-start">
      <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-3 mt-0.5 flex-shrink-0"></i>
      <div>
        <p class="text-sm font-medium text-blue-900">Seguridad de tu cuenta</p>
        <p class="text-sm text-blue-700 mt-1">
          Usa una contraseña segura de al menos 8 caracteres, combinando letras, números y símbolos.
        </p>
      </div>
    </div>
  </div>

  <!-- Card -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    
    <!-- Header -->
    <div class="px-4 md:px-8 py-4 md:py-6 border-b border-gray-100 bg-gray-50">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-blue-100 rounded-lg">
          <i data-lucide="key" class="w-5 h-5 text-blue-600"></i>
        </div>
        <div>
          <h2 class="text-lg md:text-xl font-bold text-gray-900">Cambiar Contraseña</h2>
          <p class="text-xs md:text-sm text-gray-500 mt-1">
            Actualiza tu contraseña periódicamente para mayor seguridad.
          </p>
        </div>
      </div>
    </div>

    <!-- Form -->
    <div class="p-4 md:p-8">
      <form method="POST" action="{% url 'core_web:password_change' %}" data-validate>
        {% csrf_token %}
        
        <div class="space-y-4 md:space-y-6">
          
          <!-- Contraseña Actual -->
          <div class="form-group">
            <label for="{{ form.old_password.id_for_label }}" 
                   class="block text-sm font-medium text-gray-700 mb-2">
              Contraseña Actual <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              {{ form.old_password }}
              <button type="button" 
                      onclick="togglePassword('{{ form.old_password.id_for_label }}')"
                      class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                <i data-lucide="eye" class="w-5 h-5" id="eye-{{ form.old_password.id_for_label }}"></i>
              </button>
            </div>
            {% if form.old_password.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.old_password.errors.0 }}</p>
            {% endif %}
            <p class="mt-1 text-xs text-gray-500">
              <a href="{% url 'core_web:password_reset_request' %}" 
                 class="text-blue-600 hover:text-blue-800 transition">
                ¿Olvidaste tu contraseña?
              </a>
            </p>
          </div>

          <!-- Divider -->
          <div class="border-t border-gray-200 my-6"></div>

          <!-- Nueva Contraseña -->
          <div class="form-group">
            <label for="{{ form.new_password1.id_for_label }}" 
                   class="block text-sm font-medium text-gray-700 mb-2">
              Nueva Contraseña <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              {{ form.new_password1 }}
              <button type="button" 
                      onclick="togglePassword('{{ form.new_password1.id_for_label }}')"
                      class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                <i data-lucide="eye" class="w-5 h-5" id="eye-{{ form.new_password1.id_for_label }}"></i>
              </button>
            </div>
            {% if form.new_password1.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.new_password1.errors.0 }}</p>
            {% endif %}
            
            <!-- Password Strength Indicator -->
            <div class="mt-2">
              <div class="flex items-center gap-2">
                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div id="strength-bar" class="h-full transition-all duration-300"></div>
                </div>
                <span id="strength-text" class="text-xs font-medium text-gray-500"></span>
              </div>
              
              <!-- Requirements -->
              <ul class="mt-3 space-y-1 text-xs text-gray-600">
                <li class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-4 h-4 text-gray-400" id="req-length"></i>
                  <span>Mínimo 8 caracteres</span>
                </li>
                <li class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-4 h-4 text-gray-400" id="req-letter"></i>
                  <span>Al menos una letra</span>
                </li>
                <li class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-4 h-4 text-gray-400" id="req-number"></i>
                  <span>Al menos un número</span>
                </li>
              </ul>
            </div>
          </div>

          <!-- Confirmar Nueva Contraseña -->
          <div class="form-group">
            <label for="{{ form.new_password2.id_for_label }}" 
                   class="block text-sm font-medium text-gray-700 mb-2">
              Confirmar Nueva Contraseña <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              {{ form.new_password2 }}
              <button type="button" 
                      onclick="togglePassword('{{ form.new_password2.id_for_label }}')"
                      class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                <i data-lucide="eye" class="w-5 h-5" id="eye-{{ form.new_password2.id_for_label }}"></i>
              </button>
            </div>
            {% if form.new_password2.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.new_password2.errors.0 }}</p>
            {% endif %}
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 md:mt-8 pt-4 md:pt-6 border-t border-gray-100 
                    flex flex-col-reverse sm:flex-row items-center justify-end gap-3">
          <a href="{% url 'core_web:profile' %}" 
             class="w-full sm:w-auto text-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
            Cancelar
          </a>
          <button type="submit" 
                  class="w-full sm:w-auto inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition">
            <i data-lucide="lock" class="w-4 h-4 mr-2"></i>
            Actualizar Contraseña
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  // Toggle password visibility
  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById('eye-' + fieldId);
    
    if (field.type === 'password') {
      field.type = 'text';
      icon.setAttribute('data-lucide', 'eye-off');
    } else {
      field.type = 'password';
      icon.setAttribute('data-lucide', 'eye');
    }
    
    lucide.createIcons();
  }

  // Password strength checker
  const newPasswordField = document.getElementById('{{ form.new_password1.id_for_label }}');
  
  if (newPasswordField) {
    newPasswordField.addEventListener('input', function() {
      const password = this.value;
      const strengthBar = document.getElementById('strength-bar');
      const strengthText = document.getElementById('strength-text');
      
      let strength = 0;
      let color = '';
      let text = '';
      
      // Check requirements
      const hasLength = password.length >= 8;
      const hasLetter = /[a-zA-Z]/.test(password);
      const hasNumber = /\d/.test(password);
      
      // Update requirement indicators
      updateRequirement('req-length', hasLength);
      updateRequirement('req-letter', hasLetter);
      updateRequirement('req-number', hasNumber);
      
      // Calculate strength
      if (hasLength) strength += 33;
      if (hasLetter) strength += 33;
      if (hasNumber) strength += 34;
      
      // Set color and text
      if (strength <= 33) {
        color = '#ef4444';
        text = 'Débil';
      } else if (strength <= 66) {
        color = '#f59e0b';
        text = 'Media';
      } else {
        color = '#10b981';
        text = 'Fuerte';
      }
      
      strengthBar.style.width = strength + '%';
      strengthBar.style.backgroundColor = color;
      strengthText.textContent = text;
      strengthText.style.color = color;
    });
  }
  
  function updateRequirement(id, met) {
    const icon = document.getElementById(id);
    if (met) {
      icon.classList.remove('text-gray-400');
      icon.classList.add('text-green-500');
    } else {
      icon.classList.remove('text-green-500');
      icon.classList.add('text-gray-400');
    }
  }
</script>
{% endblock %}