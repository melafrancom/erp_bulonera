{% load static %}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>{% block title %}ERP Bulonera Alvear{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema ERP/CRM para Bulonera Alvear - GestiÃ³n de inventario, ventas y clientes">
    <meta name="theme-color" content="#2563eb">
    
    <!-- Mobile Web App -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bulonera">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{% static 'pwa/icons/logo_bulonera/ios/152.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'pwa/icons/logo_bulonera/ios/152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'pwa/icons/logo_bulonera/ios/180.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'pwa/icons/logo_bulonera/ios/192.png' %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'pwa/icons/logo_bulonera/ios/32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'pwa/icons/logo_bulonera/ios/16.png' %}">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="{% static 'pwa/manifest.json' %}">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

    <!-- Tailwind Config Inline -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- Alpine.js (para sidebar toggle) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Chart.js (opcional) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}" />
    <link rel="stylesheet" href="{% static 'css/forms.css' %}" />
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}" />

    <!-- Service Worker Registration -->
    <script src="{% static 'pwa/js/sw-register.js' %}"></script>

    <!-- Custom Inline Styles -->
    <style>
      /* Sidebar styling */
      .sidebar {
        width: 260px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .nav-item {
        @apply flex items-center space-x-3 px-3 py-2.5 rounded-lg text-blue-100 hover:bg-white/10 transition-all duration-200 mb-1;
      }

      .nav-item.active {
        @apply bg-white/20 text-white font-medium;
      }

      .nav-item:hover {
        @apply text-white;
      }
      
      /* Transiciones suaves para sidebar */
      .sidebar-transition {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
    </style>

    {% block extra_css %}{% endblock %}
  </head>
  
  <body class="flex bg-gray-50 font-sans">
    
    {% if user.is_authenticated %}
      {% include 'includes/pwa.html' %}
      <!-- Layout con Alpine.js para control del sidebar -->
      <div x-data="{ sidebarOpen: false }" class="flex min-h-screen w-full">
        
        <!-- Overlay oscuro (solo mobile) -->
        <div x-show="sidebarOpen" 
             @click="sidebarOpen = false"
             x-transition:enter="transition-opacity ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black/50 z-40 lg:hidden"
             style="display: none;"></div>

        <!-- Sidebar -->
        <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
               class="sidebar fixed lg:static inset-y-0 left-0 z-50 
                      transform sidebar-transition lg:translate-x-0 
                      flex flex-col">
          {% include 'includes/dashboard_sidebar.html' %}
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col min-h-screen w-full lg:w-auto">
          
          <!-- Navbar -->
          {% include 'includes/navbar.html' %}

          <!-- Page Content -->
          <main class="flex-1 p-4 md:p-6 bg-gray-100 overflow-x-hidden">
            {% include 'includes/alerts.html' %} 
            {% block content %}
            <!-- Content will be injected here -->
            {% endblock %}
          </main>

        </div>

        <!-- Bottom Navigation (solo mobile PWA) -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-30 safe-area-bottom">
          <div class="flex items-center justify-around py-2">
            {% if user.is_manager or user.is_superuser or user.is_admin %}
            <a href="{% url 'core_web:managers_dashboard' %}" 
               class="flex flex-col items-center py-2 px-3 text-gray-600 hover:text-blue-600 transition {% if request.resolver_match.url_name == 'dashboard' %}text-blue-600{% endif %}">
              <i data-lucide="layout-dashboard" class="w-6 h-6 mb-1"></i>
              <span class="text-xs font-medium">Inicio</span>
            </a>
            {% else %}
            <a href="{% url 'core_web:dashboard' %}" 
               class="flex flex-col items-center py-2 px-3 text-gray-600 hover:text-blue-600 transition {% if request.resolver_match.url_name == 'dashboard' %}text-blue-600{% endif %}">
              <i data-lucide="layout-dashboard" class="w-6 h-6 mb-1"></i>
              <span class="text-xs font-medium">Inicio</span>
            </a>
            {% endif %}

            <a href="#" 
               class="flex flex-col items-center py-2 px-3 text-gray-600 hover:text-blue-600 transition">
              <i data-lucide="shopping-cart" class="w-6 h-6 mb-1"></i>
              <span class="text-xs font-medium">Ventas</span>
            </a>

            <a href="#" 
               class="flex flex-col items-center py-2 px-3 text-gray-600 hover:text-blue-600 transition">
              <i data-lucide="package" class="w-6 h-6 mb-1"></i>
              <span class="text-xs font-medium">Stock</span>
            </a>

            <a href="{% url 'core_web:profile' %}" 
               class="flex flex-col items-center py-2 px-3 text-gray-600 hover:text-blue-600 transition {% if request.resolver_match.url_name == 'profile' %}text-blue-600{% endif %}">
              <i data-lucide="user" class="w-6 h-6 mb-1"></i>
              <span class="text-xs font-medium">Perfil</span>
            </a>
            
          </div>
        </nav>

      </div>

    {% else %}
      <!-- Layout para usuarios NO autenticados -->
      <div class="w-full">
        {% include 'includes/pwa.html' %}
        <main class="min-h-screen">
          {% include 'includes/alerts.html' %}
          {% block Content %}{% endblock %}
        </main>
      </div>
    {% endif %}

    <!-- Custom JavaScript -->
    <script src="{% static 'js/utils.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Inicializar iconos Lucide -->
    <script>
      // Inicializar Lucide Icons
      if (typeof lucide !== "undefined") {
        lucide.createIcons();
      }

      // Cerrar sidebar al hacer clic en un link (mobile)
      document.addEventListener('alpine:init', () => {
        Alpine.data('sidebarState', () => ({
          open: false,
          toggle() {
            this.open = !this.open;
          },
          close() {
            this.open = false;
          }
        }));
      });

      // Auto-cerrar sidebar en mobile al navegar
      const navLinks = document.querySelectorAll('.sidebar .nav-item');
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 1024) {
            // Trigger Alpine close
            document.querySelector('[x-data]').__x.$data.sidebarOpen = false;
          }
        });
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>